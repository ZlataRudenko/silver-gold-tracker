{% extends "base.html" %}

{% block content %}
<div class="wrap">

    <div class="header">
        <div>
            <h1 class="title">Sell Request</h1>
            <p class="subtitle">Publish a sale request and get an estimated reference total based on current prices.</p>
        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button type="button" id="btn-buy" onclick="showBuy()" style="padding:8px 12px; border-radius:999px; border:1px solid var(--line);
        background:rgba(255,255,255,.04); color:var(--text); text-decoration:none; font-weight:800; cursor:pointer;">
                Buy
            </button>

            <button type="button" id="btn-sell" onclick="showSell()"
                style="padding:8px 12px; border-radius:999px; border:1px solid var(--line);
        background:rgba(9, 101, 229, 0.626); color:var(--text); text-decoration:none; font-weight:800; cursor:pointer;">
                Sell
            </button>
        </div>


        <div class="pill">
            <span class="dot"></span>
            <span>Live estimate</span>
        </div>
    </div>

    <div class="card">
        <div class="label">
            <div class="metal">
                <span class="icon">✉</span>
                <span>Sale details</span>
            </div>
            <span class="badge">We store price + timestamp</span>
        </div>

        {% if error %}
        <p style="color:#ff6b6b; margin: 0 0 12px 0;">{{ error }}</p>
        {% endif %}

        {% if success %}
        <div
            style="margin: 10px 0 14px 0; padding: 12px 14px; border: 1px solid var(--line); border-radius: 14px; background: rgba(34,197,94,.08);">
            <strong>✅ Sale request published.</strong>
            {% if inquiry_id %} ID: <span class="mono">{{ inquiry_id }}</span>{% endif %}
        </div>
        {% endif %}

        {# =========================
        FORM #1: PREVIEW (goes to /sell/preview)
        ========================= #}

        <div id="sell-form">
            {% if not success %}
            <form method="post" action="/sell/preview" style="display:grid; gap:12px; max-width: 760px;">

                <input type="hidden" name="side" value="sell">

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <div>
                        <label style="color:var(--muted); font-size:13px;">Name</label><br>
                        <input name="name" required value="{{ name or '' }}"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                    </div>

                    <div>
                        <label style="color:var(--muted); font-size:13px;">Contact (Email / Phone /
                            Telegram)</label><br>
                        <input name="contact" required value="{{ contact or '' }}"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;">
                    <div>
                        <label style="color:var(--muted); font-size:13px;">Metal</label><br>
                        <select name="metal"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                            <option value="silver" {% if metal=='silver' %}selected{% endif %}>Silver</option>
                            <option value="gold" {% if metal=='gold' %}selected{% endif %}>Gold</option>
                        </select>
                    </div>

                    <div>
                        <label style="color:var(--muted); font-size:13px;">Product type</label><br>
                        <select name="product_type"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                            <option value="bar" {% if product_type=='bar' %}selected{% endif %}>Bar</option>
                            <option value="coin" {% if product_type=='coin' %}selected{% endif %}>Coin</option>
                            <option value="jewelry" {% if product_type=='jewelry' %}selected{% endif %}>Jewelry</option>
                            <option value="other" {% if product_type=='other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>

                    <div>
                        <label style="color:var(--muted); font-size:13px;">Purity (e.g. 999, 925, 750,
                            unknown)</label><br>
                        <input name="purity" value="{{ purity or '' }}"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:12px; align-items:end;">
                    <div>
                        <label style="color:var(--muted); font-size:13px;">Amount</label><br>
                        <input type="number" name="amount" step="0.01" required
                            value="{{ amount if amount is not none else '' }}"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                    </div>

                    <div>
                        <label style="color:var(--muted); font-size:13px;">Unit</label><br>
                        <select name="unit"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                            <option value="g" {% if unit=='g' %}selected{% endif %}>grams</option>
                            <option value="kg" {% if unit=='kg' %}selected{% endif %}>kilograms</option>
                            <option value="oz" {% if unit=='oz' %}selected{% endif %}>ounces</option>
                            <option value="don" {% if unit=='don' %}selected{% endif %}>{{ t("unit.don") }}</option>
                        </select>
                    </div>

                    <div>
                        <button type="submit"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.08); color:var(--text); font-weight:800; cursor:pointer;">
                            Preview estimate
                        </button>
                    </div>
                </div>

                <div>
                    <label style="color:var(--muted); font-size:13px;">Location (city / country)</label><br>
                    <input name="location" value="{{ location or '' }}"
                        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                </div>

                <div>
                    <label style="color:var(--muted); font-size:13px;">Message (optional)</label><br>
                    <textarea name="message" rows="4"
                        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text); resize:vertical;">{{ message or '' }}</textarea>
                </div>

            </form>
            {% endif %}

            {# =========================
            PREVIEW BLOCK + CONFIRM FORM (Form #2)
            Show only when estimate exists AND not success
            ========================= #}
            {% if estimate is not none and not success %}
            <div class="meta" style="margin-top:16px;">
                <span><span class="icon">₩</span> Used price: <strong class="mono">{{ price_per_gram }}</strong> KRW /
                    g</span>
                {% if usdkrw is not none %}
                <span><span class="icon">₩</span> USD→KRW: <strong class="mono">{{ usdkrw }}</strong></span>
                {% endif %}
                {% if used_at %}
                <span><span class="icon">⏱</span> Timestamp: <strong class="mono">{{ used_at }}</strong></span>
                {% endif %}
            </div>

            <p class="value mono" style="margin-top:16px;">
                {{ estimate }} <span style="font-size:16px; font-weight:700; color:rgba(255,255,255,.75);">KRW</span>
            </p>
            <div class="unit">Reference estimated total</div>

            <div style="margin-top:14px; display:flex; gap:12px; flex-wrap:wrap;">
                {# FORM #2: Confirm & Publish (goes to /sell) #}
                <form method="post" action="/sell" style="margin:0;">
                    <input type="hidden" name="confirm" value="1">
                    <input type="hidden" name="side" value="sell">

                    <input type="hidden" name="name" value="{{ name }}">
                    <input type="hidden" name="contact" value="{{ contact }}">
                    <input type="hidden" name="metal" value="{{ metal }}">
                    <input type="hidden" name="product_type" value="{{ product_type }}">
                    <input type="hidden" name="purity" value="{{ purity }}">
                    <input type="hidden" name="amount" value="{{ amount }}">
                    <input type="hidden" name="unit" value="{{ unit }}">
                    <input type="hidden" name="location" value="{{ location }}">
                    <input type="hidden" name="message" value="{{ message }}">

                    <button type="submit"
                        style="padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:rgba(34,197,94,.18); color:var(--text); font-weight:900; cursor:pointer;">
                        Confirm & Publish
                    </button>
                </form>

                <div style="color:var(--muted); font-size:12px; align-self:center;">
                    Please verify the estimate before publishing. Prices may change with market updates.
                </div>
            </div>
            {% endif %}

        </div>

        <div id="buy-form" style="display:none;">

            {# =========================
            BUY — FORM #1: PREVIEW (goes to /inquiry/preview)
            ========================= #}
            {% if not success %}
            <form method="post" action="/inquiry/preview" style="display:grid; gap:12px; max-width: 760px;">

                <input type="hidden" name="side" value="buy">

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <div>
                        <label style="color:var(--muted); font-size:13px;">Name</label><br>
                        <input name="name" required value="{{ name or '' }}"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                    </div>

                    <div>
                        <label style="color:var(--muted); font-size:13px;">Contact (Email / Phone /
                            Telegram)</label><br>
                        <input name="contact" required value="{{ contact or '' }}"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;">
                    <div>
                        <label style="color:var(--muted); font-size:13px;">Metal</label><br>
                        <select name="metal"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                            <option value="silver" {% if metal=='silver' %}selected{% endif %}>Silver</option>
                            <option value="gold" {% if metal=='gold' %}selected{% endif %}>Gold</option>
                        </select>
                    </div>

                    <div>
                        <label style="color:var(--muted); font-size:13px;">Product type</label><br>
                        <select name="product_type"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                            <option value="bar" {% if product_type=='bar' %}selected{% endif %}>Bar</option>
                            <option value="coin" {% if product_type=='coin' %}selected{% endif %}>Coin</option>
                            <option value="jewelry" {% if product_type=='jewelry' %}selected{% endif %}>Jewelry</option>
                            <option value="other" {% if product_type=='other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>

                    <div>
                        <label style="color:var(--muted); font-size:13px;">Purity (e.g. 999, 925, 750,
                            unknown)</label><br>
                        <input name="purity" value="{{ purity or '' }}"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:12px; align-items:end;">
                    <div>
                        <label style="color:var(--muted); font-size:13px;">Amount</label><br>
                        <input type="number" name="amount" step="0.01" required
                            value="{{ amount if amount is not none else '' }}"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                    </div>

                    <div>
                        <label style="color:var(--muted); font-size:13px;">Unit</label><br>
                        <select name="unit"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                            <option value="g" {% if unit=='g' %}selected{% endif %}>grams</option>
                            <option value="kg" {% if unit=='kg' %}selected{% endif %}>kilograms</option>
                            <option value="oz" {% if unit=='oz' %}selected{% endif %}>ounces</option>
                            <option value="don" {% if unit=='don' %}selected{% endif %}>{{ t("unit.don") }}</option>
                        </select>
                    </div>

                    <div>
                        <button type="submit"
                            style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.08); color:var(--text); font-weight:800; cursor:pointer;">
                            Preview estimate
                        </button>
                    </div>
                </div>

                <div>
                    <label style="color:var(--muted); font-size:13px;">Location (city / country)</label><br>
                    <input name="location" value="{{ location or '' }}"
                        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                </div>

                <div>
                    <label style="color:var(--muted); font-size:13px;">Message</label><br>
                    <textarea name="message" rows="4"
                        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text); resize:vertical;">{{ message or '' }}</textarea>
                </div>

            </form>
            {% endif %}

            {# =========================
            BUY — PREVIEW BLOCK + FORM #2 (Confirm & Send)
            ========================= #}
            {% if estimate is not none and not success %}
            <div class="meta" style="margin-top:16px;">
                <span><span class="icon">₩</span> Used price: <strong class="mono">{{ price_per_gram }}</strong> KRW /
                    g</span>
                {% if usdkrw is not none %}
                <span><span class="icon">₩</span> USD→KRW: <strong class="mono">{{ usdkrw }}</strong></span>
                {% endif %}
                {% if used_at %}
                <span><span class="icon">⏱</span> Timestamp: <strong class="mono">{{ used_at }}</strong></span>
                {% endif %}
            </div>

            <p class="value mono" style="margin-top:16px;">
                {{ estimate }} <span style="font-size:16px; font-weight:700; color:rgba(255,255,255,.75);">KRW</span>
            </p>
            <div class="unit">Estimated total</div>

            <div style="margin-top:14px; display:flex; gap:12px; flex-wrap:wrap;">
                <form method="post" action="/inquiry" style="margin:0;">
                    <input type="hidden" name="confirm" value="1">
                    <input type="hidden" name="side" value="buy">

                    <input type="hidden" name="name" value="{{ name }}">
                    <input type="hidden" name="contact" value="{{ contact }}">
                    <input type="hidden" name="metal" value="{{ metal }}">
                    <input type="hidden" name="product_type" value="{{ product_type }}">
                    <input type="hidden" name="purity" value="{{ purity }}">
                    <input type="hidden" name="amount" value="{{ amount }}">
                    <input type="hidden" name="unit" value="{{ unit }}">
                    <input type="hidden" name="location" value="{{ location }}">
                    <input type="hidden" name="message" value="{{ message }}">

                    <button type="submit"
                        style="padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:rgba(34,197,94,.18); color:var(--text); font-weight:900; cursor:pointer;">
                        Confirm & Send
                    </button>
                </form>

                <div style="color:var(--muted); font-size:12px; align-self:center;">
                    Please verify the estimate before sending. Prices may change with market updates.
                </div>
            </div>
            {% endif %}

        </div>


        <div class="footer">
            <div>We store estimate details to handle callbacks and confirmations.</div>
            <div>Auto-prices via <a href="/api/prices" target="_blank">/api/prices</a></div>
        </div>

    </div>

    <script>
        function showBuy() {
            document.getElementById("buy-form").style.display = "block";
            document.getElementById("sell-form").style.display = "none";

            document.getElementById("btn-buy").style.background = "rgba(9, 101, 229, 0.626)";
            document.getElementById("btn-sell").style.background = "rgba(255,255,255,.04)";
        }

        function showSell() {
            document.getElementById("buy-form").style.display = "none";
            document.getElementById("sell-form").style.display = "block";

            document.getElementById("btn-sell").style.background = "rgba(9, 101, 229, 0.626)";
            document.getElementById("btn-buy").style.background = "rgba(255,255,255,.04)";
        }
    </script>

    {% endblock %}