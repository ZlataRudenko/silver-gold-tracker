{% extends "base.html" %}

{% block content %}
<div class="wrap">

    <div class="header">
        <div>
            {% if side == "buy" %}
            <h1 class="title">{{ t("page.request.buy_title") }}</h1>
            <p class="subtitle">{{ t("page.request.subtitle") }}</p>
            {% else %}
            <h1 class="title">{{ t("page.request.sell_title") }}</h1>
            <p class="subtitle">{{ t("page.request.subtitle") }}</p>
            {% endif %}
        </div>

        <div class="header">

            <div class="header-right">
                <div class="header-controls">
                    <div class="side-toggle">
                        <a class="side-btn {% if side=='buy' %}active{% endif %}" href="/request?side=buy">
                            {{ t("page.request.buy_tab") }}
                        </a>
                        <a class="side-btn {% if side=='sell' %}active{% endif %}" href="/request?side=sell">
                            {{ t("page.request.sell_tab") }}
                        </a>
                    </div>

                    <div class="pill live-pill">
                        <span class="dot"></span>
                        <span>{{ t("common.live_estimate") }}</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="card">
        <div class="label">
            <div class="metal">
                <span class="icon">✉</span>
                <span>
                    {% if side == "buy" %}{{ t("page.request.details_buy") }}{% else %}{{ t("page.request.details_sell")
                    }}{% endif %}
                </span>
            </div>
            <span class="badge">{{ t("page.request.store_price_ts") }}</span>
        </div>

        {% if error %}
        <p style="color:#ff6b6b; margin: 0 0 12px 0;">{{ error }}</p>
        {% endif %}

        {% if success %}
        <div
            style="margin: 10px 0 14px 0; padding: 12px 14px; border: 1px solid var(--line); border-radius: 14px; background: rgba(34,197,94,.08);">
            {% if side == "buy" %}
            <strong>✅ Inquiry sent.</strong>
            {% else %}
            <strong>✅ Sale request published.</strong>
            {% endif %}
            {% if request_id %} ID: <span class="mono">{{ request_id }}</span>{% endif %}
        </div>
        {% endif %}

        {# FORM #1: PREVIEW #}
        {% if not success %}
        <form method="post" action="/request/preview" style="display:grid; gap:12px; max-width: 760px;">
            <input type="hidden" name="side" value="{{ side }}">

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div>
                    <label style="color:var(--muted); font-size:13px;">{{ t("form.name") }}</label><br>
                    <input name="name" required value="{{ name or '' }}"
                        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                </div>

                <div>
                    <label style="color:var(--muted); font-size:13px;">{{ t("form.contact") }}</label><br>
                    <input name="contact" required value="{{ contact or '' }}"
                        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;">
                <div>
                    <label style="color:var(--muted); font-size:13px;">{{ t("metal.label") }}</label><br>
                    <select name="metal"
                        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                        <option value="silver" {% if metal=='silver' %}selected{% endif %}>{{ t("metal.silver") }}
                        </option>
                        <option value="gold" {% if metal=='gold' %}selected{% endif %}>{{ t("metal.gold") }}</option>
                    </select>
                </div>

                <div>
                    <label style="color:var(--muted); font-size:13px;">{{ t("form.product_type") }}</label><br>
                    <select name="product_type"
                        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                        <option value="bar" {% if product_type=='bar' %}selected{% endif %}>{{ t("product.bar") }}
                        </option>
                        <option value="coin" {% if product_type=='coin' %}selected{% endif %}>{{ t("product.coin") }}
                        </option>
                        <option value="jewelry" {% if product_type=='jewelry' %}selected{% endif %}>{{
                            t("product.jewelry") }}</option>
                        <option value="other" {% if product_type=='other' %}selected{% endif %}>{{ t("product.other") }}
                        </option>
                    </select>
                </div>

                <div>
                    <label style="color:var(--muted); font-size:13px;">{{ t("form.purity_hint") }}</label><br>
                    <input name="purity" value="{{ purity or '' }}"
                        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:12px; align-items:end;">
                <div>
                    <label style="color:var(--muted); font-size:13px;">{{ t("form.amount") }}</label><br>
                    <input type="number" name="amount" step="0.01" required
                        value="{{ amount if amount is not none else '' }}"
                        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                </div>

                <div>
                    <label style="color:var(--muted); font-size:13px;">{{ t("unit.label") }}</label><br>
                    <select name="unit"
                        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
                        <option value="g" {% if unit=='g' %}selected{% endif %}>{{ t("unit.g") }}</option>
                        <option value="kg" {% if unit=='kg' %}selected{% endif %}>{{ t("unit.kg") }}</option>
                        <option value="oz" {% if unit=='oz' %}selected{% endif %}>{{ t("unit.oz") }}</option>
                        <option value="don" {% if unit=='don' %}selected{% endif %}>{{ t("unit.don") }}</option>
                    </select>
                </div>

                <div>
                    <button type="submit"
                        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.08); color:var(--text); font-weight:800; cursor:pointer;">{{
                        t("btn.preview_estimate") }}</button>
                </div>
            </div>

            <div>
                <label style="color:var(--muted); font-size:13px;">{{ t("form.location_hint") }}</label><br>
                <input name="location" value="{{ location or '' }}"
                    style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);">
            </div>

            <div>
                <label style="color:var(--muted); font-size:13px;">{{ t("form.message_optional") }}</label><br>
                <textarea name="message" rows="4" placeholder="{{ t('form.type_message') }}"
                    style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text); resize:vertical;">{{ message or '' }}</textarea>
            </div>
        </form>
        {% endif %}

        {# PREVIEW + CONFIRM #}
        {% if estimate is not none and not success %}
        <div class="meta" style="margin-top:16px;">
            <span><span class="icon">₩</span> {{ t("common.used_price") }}: <strong class="mono">{{ price_per_gram
                    }}</strong> KRW / g</span>
            {% if usdkrw is not none %}
            <span><span class="icon">₩</span> USD→KRW: <strong class="mono">{{ usdkrw }}</strong></span>
            {% endif %}
            {% if used_at %}
            <span><span class="icon">⏱</span> {{ t("common.timestamp") }}: <strong class="mono">{{ used_at
                    }}</strong></span>
            {% endif %}
        </div>

        <p class="value mono" style="margin-top:16px;">
            {{ estimate }} <span style="font-size:16px; font-weight:700; color:rgba(255,255,255,.75);">KRW</span>
        </p>
        <div class="unit">
            {% if side == "buy" %}{{ t("common.estimated_total") }}{% else %}{{ t("common.reference_estimated_total")
            }}{% endif %}
        </div>

        <div style="margin-top:14px; display:flex; gap:12px; flex-wrap:wrap;">
            <form method="post" action="/request/confirm" style="margin:0;">
                <input type="hidden" name="confirm" value="1">
                <input type="hidden" name="side" value="{{ side }}">

                <input type="hidden" name="name" value="{{ name }}">
                <input type="hidden" name="contact" value="{{ contact }}">
                <input type="hidden" name="metal" value="{{ metal }}">
                <input type="hidden" name="product_type" value="{{ product_type }}">
                <input type="hidden" name="purity" value="{{ purity }}">
                <input type="hidden" name="amount" value="{{ amount }}">
                <input type="hidden" name="unit" value="{{ unit }}">
                <input type="hidden" name="location" value="{{ location }}">
                <input type="hidden" name="message" value="{{ message }}">

                <button type="submit"
                    style="padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:rgba(34,197,94,.18); color:var(--text); font-weight:900; cursor:pointer;">
                    {% if side == "buy" %}{{ t("btn.confirm_send") }}{% else %}{{ t("btn.confirm_publish") }}{% endif %}
                </button>
            </form>

            <div style="color:var(--muted); font-size:12px; align-self:center;">
                {{ t("page.request.verify_note") }}
            </div>
        </div>
        {% endif %}

    </div>

    <div class="footer">
        <div>{{ t("page.request.footer_store_estimate") }}</div>
        <div>{{ t("page.request.footer_autoprices") }} <a href="/api/prices" target="_blank">/api/prices</a></div>
    </div>

</div>
{% endblock %}